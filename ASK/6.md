é€™å€‹éŒ¯èª¤æ˜¯å› ç‚ºä»£ç¢¼æœ€å¾Œä¸€è¡Œçš„å•é¡Œï¼`return` ä¸èƒ½åœ¨å‡½æ•¸å¤–éƒ¨ä½¿ç”¨ã€‚

## âŒ **å•é¡Œæ‰€åœ¨ï¼š**

æˆ‘ä¹‹å‰æä¾›çš„ä»£ç¢¼æœ€å¾Œæœ‰é€™ä¸€è¡Œï¼š
```python
# èª¿ç”¨ä¸»å‡½æ•¸
return main(teacher_output)  # â† é€™è¡Œæ˜¯éŒ¯çš„ï¼
```

**åœ¨ Dify ä¸­ä¸éœ€è¦é€™è¡Œï¼** Dify æœƒè‡ªå‹•èª¿ç”¨ `main()` å‡½æ•¸ã€‚

---

## âœ… **æ­£ç¢ºçš„å®Œæ•´ä»£ç¢¼ï¼š**

ç›´æ¥è¤‡è£½é€™å€‹ç‰ˆæœ¬åˆ° Dify ä»£ç¢¼ç¯€é»ï¼š

```python
def main(teacher_output: str) -> dict:
    """
    è§£æè€å¸«çš„è¼¸å‡ºï¼Œæå–çµæ§‹åŒ–æ•¸æ“š
    """
    import json
    import re
    
    try:
        # å˜—è©¦æ‰¾åˆ°JSONéƒ¨åˆ†ï¼ˆè™•ç†å¯èƒ½çš„é¡å¤–æ–‡å­—ï¼‰
        json_match = re.search(r'\{.*\}', teacher_output, re.DOTALL)
        
        if json_match:
            json_str = json_match.group()
            data = json.loads(json_str)
            
            # é©—è­‰å¿…è¦æ¬„ä½
            required_fields = ['problem_analysis', 'optimized_question', 
                             'extended_questions', 'knowledge_structure']
            
            for field in required_fields:
                if field not in data:
                    raise ValueError(f"Missing required field: {field}")
            
            # æ ¼å¼åŒ–è¼¸å‡ºä¾›å¾ŒçºŒä½¿ç”¨
            return {
                "status": "success",
                "parsed_data": data,
                "main_question": data['optimized_question']['refined_version'],
                "extended_questions_list": [
                    q['question'] for q in data['extended_questions']
                ],
                "formatted_output": format_for_display(data)
            }
        else:
            raise ValueError("No JSON found in output")
            
    except json.JSONDecodeError as e:
        return {
            "status": "error",
            "error_message": f"JSONè§£æå¤±æ•—: {str(e)}",
            "raw_output": teacher_output,
            "main_question": "",
            "extended_questions_list": [],
            "formatted_output": f"è§£æéŒ¯èª¤ï¼š{str(e)}"
        }
    except Exception as e:
        return {
            "status": "error", 
            "error_message": str(e),
            "raw_output": teacher_output,
            "main_question": "",
            "extended_questions_list": [],
            "formatted_output": f"è™•ç†éŒ¯èª¤ï¼š{str(e)}"
        }

def format_for_display(data: dict) -> str:
    """
    å°‡æ•¸æ“šæ ¼å¼åŒ–ç‚ºæ˜“è®€çš„æ–‡æœ¬
    """
    output = []
    
    # å•é¡Œåˆ†æ
    analysis = data['problem_analysis']
    output.append("ğŸ“Š **å•é¡Œåˆ†æ**")
    output.append(f"- æ ¸å¿ƒæ¦‚å¿µï¼š{analysis['core_concept']}")
    output.append(f"- è¤‡é›œåº¦ï¼š{analysis['complexity_level']}")
    output.append(f"- å­¸ç¿’æ„åœ–ï¼š{analysis['learner_intent']}\n")
    
    # å„ªåŒ–å¾Œçš„å•é¡Œ
    optimized = data['optimized_question']
    output.append("ğŸ¯ **å„ªåŒ–å¾Œçš„å•é¡Œ**")
    output.append(f"ä¸»è¦å•é¡Œï¼š{optimized['refined_version']}")
    output.append(f"èƒŒæ™¯èªªæ˜ï¼š{optimized['context']}")
    output.append(f"è¨è«–ç¯„åœï¼š{optimized['scope']}\n")
    
    # å»¶ä¼¸å•é¡Œ
    output.append("ğŸ” **å»¶ä¼¸æ¢è¨æ–¹å‘**")
    for i, q in enumerate(data['extended_questions'], 1):
        output.append(f"\n{i}. [{q['perspective']}]")
        output.append(f"   å•é¡Œï¼š{q['question']}")
        output.append(f"   åƒ¹å€¼ï¼š{q['learning_value']}")
    
    # çŸ¥è­˜çµæ§‹
    knowledge = data['knowledge_structure']
    output.append("\nğŸ“š **çŸ¥è­˜æ¶æ§‹**")
    output.append(f"- ä¸»è¦é ˜åŸŸï¼š{knowledge['primary_domain']}")
    output.append(f"- ç›¸é—œé ˜åŸŸï¼š{', '.join(knowledge['related_fields'])}")
    output.append(f"- å‰ç½®çŸ¥è­˜ï¼š{', '.join(knowledge['prerequisites'])}")
    output.append(f"- é€²éšä¸»é¡Œï¼š{', '.join(knowledge['advanced_topics'])}")
    
    return "\n".join(output)
```

---

## ğŸ”‘ **é—œéµä¿®æ”¹é»ï¼š**

### **åˆªé™¤äº†ï¼š**
```python
# èª¿ç”¨ä¸»å‡½æ•¸
return main(teacher_output)  # âŒ åˆªé™¤é€™è¡Œ
```

### **ä¿æŒï¼š**
- `def main(teacher_output: str) -> dict:` å‡½æ•¸å®šç¾©
- `def format_for_display(data: dict) -> str:` è¼”åŠ©å‡½æ•¸
- å‡½æ•¸å…§éƒ¨çš„ `return` èªå¥ âœ“

---

## ğŸ“ **Dify ä»£ç¢¼ç¯€é»çš„è¦å‰‡ï¼š**

```python
# âœ… æ­£ç¢ºçµæ§‹
def main(arg1, arg2):
    # ä½ çš„é‚è¼¯
    return result

def helper_function():
    # è¼”åŠ©å‡½æ•¸
    return something

# Dify æœƒè‡ªå‹•èª¿ç”¨ main()
# ä¸éœ€è¦æ‰‹å‹•èª¿ç”¨ï¼
```

```python
# âŒ éŒ¯èª¤çµæ§‹
def main(arg1):
    return result

return main(arg1)  # âŒ éŒ¯èª¤ï¼ä¸éœ€è¦é€™è¡Œ
```

---

## ğŸ§ª **æ¸¬è©¦æ­¥é©Ÿï¼š**

1. **åˆªé™¤èˆŠä»£ç¢¼**
2. **è²¼ä¸Šä¸Šé¢çš„æ­£ç¢ºç‰ˆæœ¬**
3. **ç¢ºèªè¼¸å…¥è®Šæ•¸è¨­å®šï¼š**
   ```yaml
   teacher_output â†’ {{LLMç¯€é»åç¨±.text}}
   ```
4. **é»æ“Šã€Œé‹è¡Œã€æ¸¬è©¦**

---

## ğŸ’¡ **é¡å¤–å„ªåŒ–å»ºè­°ï¼š**

å¦‚æœé‚„æƒ³è®“ä»£ç¢¼æ›´ç©©å¥ï¼Œå¯ä»¥åœ¨éŒ¯èª¤è™•ç†æ™‚ç¢ºä¿æ‰€æœ‰æ¬„ä½éƒ½æœ‰å€¼ï¼š

```python
except Exception as e:
    return {
        "status": "error", 
        "error_message": str(e),
        "raw_output": teacher_output,
        "main_question": "",  # æ·»åŠ ç©ºå€¼
        "extended_questions_list": [],  # æ·»åŠ ç©ºé™£åˆ—
        "formatted_output": f"è™•ç†éŒ¯èª¤ï¼š{str(e)}",  # æ·»åŠ éŒ¯èª¤è¨Šæ¯
        "parsed_data": {}  # æ·»åŠ ç©ºç‰©ä»¶
    }
```

é€™æ¨£å³ä½¿å‡ºéŒ¯ï¼Œå¾ŒçºŒç¯€é»ä¹Ÿèƒ½æ­£å¸¸å¼•ç”¨è®Šæ•¸ï¼ˆåªæ˜¯å€¼ç‚ºç©ºï¼‰ã€‚

---

ç¾åœ¨æ‡‰è©²å¯ä»¥æ­£å¸¸é‹è¡Œäº†ï¼å¦‚æœé‚„æœ‰éŒ¯èª¤ï¼Œè«‹æŠŠæ–°çš„éŒ¯èª¤è¨Šæ¯è²¼çµ¦æˆ‘çœ‹ã€‚
