åœ¨ Dify çš„ä»£ç¢¼ç¯€é»ä¸­è¨­å®šé€™å€‹ç¨‹å¼ç¢¼çš„è¼¸å…¥è¼¸å‡ºï¼Œè«‹æŒ‰ç…§ä»¥ä¸‹æ­¥é©Ÿï¼š

## ğŸ”§ **ä»£ç¢¼ç¯€é»é…ç½®è©³è§£**

### **Step 1: è¼¸å…¥è®Šæ•¸è¨­å®š**

åœ¨ä»£ç¢¼ç¯€é»çš„ã€Œè¼¸å…¥è®Šæ•¸ã€å€å¡Šï¼š

```yaml
è®Šæ•¸åç¨±: teacher_output
è®Šæ•¸é¡å‹: String (å­—ä¸²)
è®Šæ•¸ä¾†æº: Teacher_Question_Optimizer (ä¸Šä¸€å€‹LLMç¯€é»çš„è¼¸å‡º)
```

**åœ¨ Dify ä»‹é¢æ“ä½œï¼š**
1. é»æ“Šä»£ç¢¼ç¯€é»
2. åœ¨å³å´é¢æ¿æ‰¾åˆ°ã€Œè¼¸å…¥è®Šæ•¸ã€
3. é»æ“Šã€Œ+ æ·»åŠ è®Šæ•¸ã€
4. è¨­å®šï¼š
   - è®Šæ•¸åï¼š`teacher_output`
   - é¡å‹é¸æ“‡ï¼š`String`
   - è®Šæ•¸å¼•ç”¨ï¼šé»æ“Šè¼¸å…¥æ¡†ï¼Œé¸æ“‡ `Teacher_Question_Optimizer.text`

### **Step 2: è¼¸å‡ºè®Šæ•¸è¨­å®š**

é€™å€‹å‡½æ•¸å›å‚³çš„æ˜¯ dictï¼ŒåŒ…å«å¤šå€‹æ¬„ä½ï¼Œåœ¨ Dify ä¸­éœ€è¦è¨­å®šï¼š

```yaml
è¼¸å‡ºè®Šæ•¸é¡å‹: Object (ç‰©ä»¶/å°è±¡)
```

**è¼¸å‡ºçµæ§‹ï¼š**
```python
{
    "status": "success/error",
    "parsed_data": {...},  # å®Œæ•´çš„JSONæ•¸æ“š
    "main_question": "...",  # ä¸»è¦å•é¡Œæ–‡å­—
    "extended_questions_list": [...],  # å»¶ä¼¸å•é¡Œé™£åˆ—
    "formatted_output": "...",  # æ ¼å¼åŒ–çš„é¡¯ç¤ºæ–‡å­—
    "error_message": "...",  # éŒ¯èª¤è¨Šæ¯ï¼ˆåƒ…åœ¨éŒ¯èª¤æ™‚ï¼‰
    "raw_output": "..."  # åŸå§‹è¼¸å‡ºï¼ˆåƒ…åœ¨éŒ¯èª¤æ™‚ï¼‰
}
```

### **Step 3: å®Œæ•´çš„ä»£ç¢¼ç¯€é»é…ç½®**

åœ¨ Dify ä»£ç¢¼ç·¨è¼¯å™¨ä¸­ï¼Œå®Œæ•´ä»£ç¢¼æ‡‰è©²æ˜¯é€™æ¨£ï¼š

```python
def main(teacher_output: str) -> dict:
    """
    è§£æè€å¸«çš„è¼¸å‡ºï¼Œæå–çµæ§‹åŒ–æ•¸æ“š
    """
    import json
    import re
    
    try:
        # å˜—è©¦æ‰¾åˆ°JSONéƒ¨åˆ†ï¼ˆè™•ç†å¯èƒ½çš„é¡å¤–æ–‡å­—ï¼‰
        json_match = re.search(r'\{.*\}', teacher_output, re.DOTALL)
        
        if json_match:
            json_str = json_match.group()
            data = json.loads(json_str)
            
            # é©—è­‰å¿…è¦æ¬„ä½
            required_fields = ['problem_analysis', 'optimized_question', 
                             'extended_questions', 'knowledge_structure']
            
            for field in required_fields:
                if field not in data:
                    raise ValueError(f"Missing required field: {field}")
            
            # æ ¼å¼åŒ–è¼¸å‡ºä¾›å¾ŒçºŒä½¿ç”¨
            return {
                "status": "success",
                "parsed_data": data,
                "main_question": data['optimized_question']['refined_version'],
                "extended_questions_list": [
                    q['question'] for q in data['extended_questions']
                ],
                "formatted_output": format_for_display(data)
            }
            
    except json.JSONDecodeError as e:
        return {
            "status": "error",
            "error_message": f"JSONè§£æå¤±æ•—: {str(e)}",
            "raw_output": teacher_output
        }
    except Exception as e:
        return {
            "status": "error", 
            "error_message": str(e),
            "raw_output": teacher_output
        }

def format_for_display(data: dict) -> str:
    """
    å°‡æ•¸æ“šæ ¼å¼åŒ–ç‚ºæ˜“è®€çš„æ–‡æœ¬
    """
    output = []
    
    # å•é¡Œåˆ†æ
    analysis = data['problem_analysis']
    output.append("ğŸ“Š **å•é¡Œåˆ†æ**")
    output.append(f"- æ ¸å¿ƒæ¦‚å¿µï¼š{analysis['core_concept']}")
    output.append(f"- è¤‡é›œåº¦ï¼š{analysis['complexity_level']}")
    output.append(f"- å­¸ç¿’æ„åœ–ï¼š{analysis['learner_intent']}\n")
    
    # å„ªåŒ–å¾Œçš„å•é¡Œ
    optimized = data['optimized_question']
    output.append("ğŸ¯ **å„ªåŒ–å¾Œçš„å•é¡Œ**")
    output.append(f"ä¸»è¦å•é¡Œï¼š{optimized['refined_version']}")
    output.append(f"èƒŒæ™¯èªªæ˜ï¼š{optimized['context']}")
    output.append(f"è¨è«–ç¯„åœï¼š{optimized['scope']}\n")
    
    # å»¶ä¼¸å•é¡Œ
    output.append("ğŸ” **å»¶ä¼¸æ¢è¨æ–¹å‘**")
    for i, q in enumerate(data['extended_questions'], 1):
        output.append(f"\n{i}. [{q['perspective']}]")
        output.append(f"   å•é¡Œï¼š{q['question']}")
        output.append(f"   åƒ¹å€¼ï¼š{q['learning_value']}")
    
    # çŸ¥è­˜çµæ§‹
    knowledge = data['knowledge_structure']
    output.append("\nğŸ“š **çŸ¥è­˜æ¶æ§‹**")
    output.append(f"- ä¸»è¦é ˜åŸŸï¼š{knowledge['primary_domain']}")
    output.append(f"- ç›¸é—œé ˜åŸŸï¼š{', '.join(knowledge['related_fields'])}")
    output.append(f"- å‰ç½®çŸ¥è­˜ï¼š{', '.join(knowledge['prerequisites'])}")
    output.append(f"- é€²éšä¸»é¡Œï¼š{', '.join(knowledge['advanced_topics'])}")
    
    return "\n".join(output)
```

### **Step 4: åœ¨å¾ŒçºŒç¯€é»ä¸­ä½¿ç”¨è¼¸å‡º**

#### **A. ä½¿ç”¨æ ¼å¼åŒ–è¼¸å‡ºé¡¯ç¤ºçµ¦ç”¨æˆ¶**
```yaml
ç¯€é»é¡å‹: æ–‡æœ¬å›è¦†
å¼•ç”¨è®Šæ•¸: {{Parse_Teacher_Output.formatted_output}}
```

#### **B. ä½¿ç”¨ä¸»è¦å•é¡Œå‚³çµ¦å­¸ç”Ÿ**
```yaml
ç¯€é»é¡å‹: LLM (å­¸ç”Ÿå›ç­”)
Promptä¸­å¼•ç”¨: {{Parse_Teacher_Output.main_question}}
```

#### **C. ä½¿ç”¨å»¶ä¼¸å•é¡Œåˆ—è¡¨**
```yaml
ç¯€é»é¡å‹: LLM
Promptæ¨¡æ¿:
"""
è«‹å›ç­”ä»¥ä¸‹å•é¡Œï¼š
ä¸»è¦å•é¡Œï¼š{{Parse_Teacher_Output.main_question}}

å»¶ä¼¸æ€è€ƒï¼š
{% for question in Parse_Teacher_Output.extended_questions_list %}
- {{question}}
{% endfor %}
"""
```

### **Step 5: æ¢ä»¶åˆ¤æ–·ä½¿ç”¨**

æ·»åŠ ä¸€å€‹æ¢ä»¶åˆ†æ”¯ç¯€é»ä¾†è™•ç†æˆåŠŸ/å¤±æ•—æƒ…æ³ï¼š

```yaml
ç¯€é»é¡å‹: æ¢ä»¶åˆ†æ”¯
æ¢ä»¶è¨­å®š:
  æ¢ä»¶1: 
    - å¦‚æœ: {{Parse_Teacher_Output.status}} == "success"
    - åŸ·è¡Œ: ç¹¼çºŒæ­£å¸¸æµç¨‹
    
  æ¢ä»¶2:
    - å¦‚æœ: {{Parse_Teacher_Output.status}} == "error"
    - åŸ·è¡Œ: éŒ¯èª¤è™•ç†æµç¨‹
```

### **Step 6: éŒ¯èª¤è™•ç†æµç¨‹**

ç•¶è§£æå¤±æ•—æ™‚çš„è™•ç†ï¼š

```yaml
ç¯€é»é¡å‹: æ–‡æœ¬
å…§å®¹: |
  è§£æå¤±æ•—ï¼
  éŒ¯èª¤ä¿¡æ¯ï¼š{{Parse_Teacher_Output.error_message}}
  
  åŸå§‹è¼¸å‡ºï¼š
  {{Parse_Teacher_Output.raw_output}}
```

### **å¯¦éš›æ“ä½œæˆªåœ–èªªæ˜**

ç”±æ–¼æˆ‘ç„¡æ³•æä¾›æˆªåœ–ï¼Œé€™è£¡ç”¨æ–‡å­—æè¿° Dify ä»‹é¢æ“ä½œï¼š

1. **ä»£ç¢¼ç¯€é»åŸºæœ¬è¨­å®š**
   ```
   ç¯€é»åç¨±: Parse_Teacher_Output
   æè¿°: è§£æè€å¸«è¼¸å‡ºçš„JSONæ•¸æ“š
   ```

2. **è¼¸å…¥è®Šæ•¸é…ç½®å€**
   ```
   [è¼¸å…¥è®Šæ•¸]
   â”œâ”€ teacher_output (String)
   â””â”€ ä¾†æº: {{Teacher_Question_Optimizer.text}}
   ```

3. **ä»£ç¢¼ç·¨è¼¯å€**
   ```python
   # è²¼ä¸Šä¸Šé¢çš„å®Œæ•´ä»£ç¢¼
   ```

4. **è¼¸å‡ºé è¦½å€**
   ```
   [è¼¸å‡ºçµæ§‹]
   â”œâ”€ status
   â”œâ”€ parsed_data
   â”œâ”€ main_question  
   â”œâ”€ extended_questions_list
   â”œâ”€ formatted_output
   â”œâ”€ error_message (optional)
   â””â”€ raw_output (optional)
   ```

### **æ¸¬è©¦ç¯„ä¾‹**

**æ¨¡æ“¬è¼¸å…¥** (teacher_output):
```json
{
  "problem_analysis": {
    "core_concept": "æ©Ÿå™¨å­¸ç¿’åŸºç¤",
    "complexity_level": "åˆç´š",
    "learner_intent": "äº†è§£AIåŸºæœ¬æ¦‚å¿µ"
  },
  "optimized_question": {
    "refined_version": "æ©Ÿå™¨å­¸ç¿’çš„åŸºæœ¬åŸç†å’Œæ‡‰ç”¨æ˜¯ä»€éº¼ï¼Ÿ",
    "context": "åœ¨AIæ™‚ä»£çš„èƒŒæ™¯ä¸‹",
    "scope": "åŸºç¤æ¦‚å¿µå’Œå¸¸è¦‹æ‡‰ç”¨"
  },
  "extended_questions": [
    {
      "perspective": "ç†è«–åŸºç¤",
      "question": "ç›£ç£å­¸ç¿’å’Œéç›£ç£å­¸ç¿’çš„å€åˆ¥ï¼Ÿ",
      "learning_value": "ç†è§£ä¸åŒå­¸ç¿’ç¯„å¼"
    }
  ],
  "knowledge_structure": {
    "primary_domain": "äººå·¥æ™ºæ…§",
    "related_fields": ["çµ±è¨ˆå­¸", "æ•¸æ“šç§‘å­¸"],
    "prerequisites": ["åŸºç¤æ•¸å­¸", "ç¨‹å¼è¨­è¨ˆ"],
    "advanced_topics": ["æ·±åº¦å­¸ç¿’", "å¼·åŒ–å­¸ç¿’"]
  }
}
```

**é æœŸè¼¸å‡º**:
```python
{
  "status": "success",
  "main_question": "æ©Ÿå™¨å­¸ç¿’çš„åŸºæœ¬åŸç†å’Œæ‡‰ç”¨æ˜¯ä»€éº¼ï¼Ÿ",
  "extended_questions_list": ["ç›£ç£å­¸ç¿’å’Œéç›£ç£å­¸ç¿’çš„å€åˆ¥ï¼Ÿ"],
  "formatted_output": "ğŸ“Š **å•é¡Œåˆ†æ**\n- æ ¸å¿ƒæ¦‚å¿µï¼šæ©Ÿå™¨å­¸ç¿’åŸºç¤..."
}
```

### **å¸¸è¦‹å•é¡Œè™•ç†**

1. **å¦‚æœ LLM è¼¸å‡ºåŒ…å«é¡å¤–æ–‡å­—ï¼Ÿ**
   - ä»£ç¢¼å·²è™•ç†ï¼šä½¿ç”¨ regex æå– JSON éƒ¨åˆ†

2. **å¦‚æœæŸäº›æ¬„ä½ç¼ºå¤±ï¼Ÿ**
   - ä»£ç¢¼æœƒå›å‚³ error status å’ŒéŒ¯èª¤è¨Šæ¯

3. **å¦‚ä½•åœ¨ä¸‹å€‹ç¯€é»ä½¿ç”¨ç‰¹å®šæ¬„ä½ï¼Ÿ**
   - ä½¿ç”¨é»è™Ÿå­˜å–ï¼š`{{Parse_Teacher_Output.main_question}}`

éœ€è¦æˆ‘é€²ä¸€æ­¥èªªæ˜æŸå€‹ç‰¹å®šéƒ¨åˆ†å—ï¼Ÿ
